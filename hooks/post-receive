#!/bin/bash

# Config
TARGET="/home/malcolm/projects/dnd-console-live"
GIT_DIR="/home/malcolm/projects/dnd-console.git"
BRANCH="main"
NGINX_DEPLOY_DIR="/var/www/websites/dnd/console"
API_SERVICE="dnd-api"

while read oldrev newrev ref
do
  if [[ "$ref" = "refs/heads/$BRANCH" ]]; then
    echo "ğŸ“¦ Deploying $BRANCH to $TARGET..."

    git --work-tree="$TARGET" --git-dir="$GIT_DIR" checkout -f "$BRANCH"

    echo "ğŸ“¦ Installing dependencies..."
    cd "$TARGET"
    npm ci

    echo "ğŸ› ï¸ Building frontend..."
    npm run build

    echo "ğŸšš Copying build to Nginx folder..."
    sudo rm -rf "$NGINX_DEPLOY_DIR"/*
    sudo cp -r dist/* "$NGINX_DEPLOY_DIR/"

    echo "ğŸ–¼ï¸  Copying images to Nginx folder..."
    sudo rsync -av --delete "$TARGET/images/" "$NGINX_DEPLOY_DIR/images/"

    echo "ğŸ”„ Restarting FastAPI backend ($API_SERVICE)..."
    sudo systemctl restart "$API_SERVICE"

    echo "âœ… Deploy complete."
  fi
done

